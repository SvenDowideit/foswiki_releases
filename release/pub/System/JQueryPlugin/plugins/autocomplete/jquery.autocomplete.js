(function(a){a.fn.extend({autocomplete:function(b,c){var d=typeof b=="string";c=a.extend({},a.Autocompleter.defaults,{url:d?b:null,data:d?null:b,delay:d?a.Autocompleter.defaults.delay:10,max:c&&!c.scroll?10:150},c);c.highlight=c.highlight||function(e){return e};c.formatMatch=c.formatMatch||c.formatItem;return this.each(function(){new a.Autocompleter(this,c)})},result:function(b){return this.bind("result",b)},search:function(b){return this.trigger("search",[b])},flushCache:function(){return this.trigger("flushCache")},setOptions:function(b){return this.trigger("setOptions",[b])},unautocomplete:function(){return this.trigger("unautocomplete")}});a.Autocompleter=function(l,h){var c={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8};var b=a(l).attr("autocomplete","off").addClass(h.inputClass);var j;var s="";var m=a.Autocompleter.Cache(h);var e=0;var w;var A={mouseDownOnSelect:false};var t=a.Autocompleter.Select(h,l,d,A);var z;var n=parseInt(b.css("margin-right"),10)||0;var p=b.outerHeight(true)+1;var x=a("<span class='ac_spinner' />").insertAfter(b).css({height:p,"margin-left":-20-n});a.browser.opera&&a(l.form).bind("submit.autocomplete",function(){if(z){z=false;return false}});b.bind((a.browser.opera?"keypress":"keydown")+".autocomplete",function(B){w=B.keyCode;switch(B.keyCode){case c.UP:B.preventDefault();if(t.visible()){t.prev()}else{v(0,true)}break;case c.DOWN:B.preventDefault();if(t.visible()){t.next()}else{v(0,true)}break;case c.PAGEUP:B.preventDefault();if(t.visible()){t.pageUp()}else{v(0,true)}break;case c.PAGEDOWN:B.preventDefault();if(t.visible()){t.pageDown()}else{v(0,true)}break;case h.multiple&&a.trim(h.multipleSeparator)==","&&c.COMMA:case c.TAB:case c.RETURN:if(d()){B.preventDefault();z=true;return false}break;case c.ESC:t.hide();break;default:clearTimeout(j);j=setTimeout(v,h.delay);break}}).focus(function(){e++}).blur(function(){e=0;if(!A.mouseDownOnSelect){u()}}).click(function(){if(e++>1&&!t.visible()){v(0,true)}}).bind("search",function(){var B=(arguments.length>1)?arguments[1]:null;function C(G,F){var D;if(F&&F.length){for(var E=0;E<F.length;E++){if(F[E].result.toLowerCase()==G.toLowerCase()){D=F[E];break}}}if(typeof B=="function"){B(D)}else{b.trigger("result",D&&[D.data,D.value])}}a.each(g(b.val()),function(D,E){f(E,C,C)})}).bind("flushCache",function(){m.flush()}).bind("setOptions",function(){a.extend(h,arguments[1]);if("data" in arguments[1]){m.populate()}}).bind("unautocomplete",function(){t.unbind();b.unbind();a(l.form).unbind(".autocomplete")});function d(){var C=t.selected();if(!C){return false}var B=C.result;s=B;if(h.multiple){var D=g(b.val());if(D.length>1){B=D.slice(0,D.length-1).join(h.multipleSeparator)+h.multipleSeparator+B}B+=h.multipleSeparator}b.val(B);y();b.trigger("result",[C.data,C.value]);return true}function v(D,C){if(w==c.DEL){t.hide();return}var B=b.val();if(!C&&B==s){return}s=B;B=i(B);if(B.length>=h.minChars){b.addClass(h.loadingClass);if(!h.matchCase){B=B.toLowerCase()}f(B,k,y)}else{o();t.hide()}}function g(C){if(!C){return[""]}var D=C.split(h.multipleSeparator);var B=[];a.each(D,function(E,F){if(a.trim(F)){B[E]=a.trim(F)}});return B}function i(B){if(!h.multiple){return B}var C=g(B);return C[C.length-1]}function r(B,C){if(h.autoFill&&(i(b.val()).toLowerCase()==B.toLowerCase())&&w!=c.BACKSPACE){b.val(b.val()+C.substring(i(s).length));a.Autocompleter.Selection(l,s.length,s.length+C.length)}}function u(){clearTimeout(j);j=setTimeout(y,200)}function y(){var B=t.visible();t.hide();clearTimeout(j);o();if(h.mustMatch){b.search(function(C){if(!C){if(h.multiple){var D=g(b.val()).slice(0,-1);b.val(D.join(h.multipleSeparator)+(D.length?h.multipleSeparator:""))}else{b.val("")}}})}if(B){a.Autocompleter.Selection(l,l.value.length,l.value.length)}}function k(C,B){if(B&&B.length&&e){o();t.display(B,C);r(C,B[0].value);t.show()}else{y()}}function f(C,E,B){if(!h.matchCase){C=C.toLowerCase()}var D=m.load(C);if(D&&D.length){E(C,D)}else{if((typeof h.url=="string")&&(h.url.length>0)){var F={timestamp:+new Date()};a.each(h.extraParams,function(G,H){F[G]=typeof H=="function"?H():H});x.css("display","inline");b.trigger("beforeSearch");a.ajax({mode:"abort",port:"autocomplete"+l.name,dataType:h.dataType,url:h.url,data:a.extend({q:i(C),limit:h.max},F),success:function(H){var G=h.parse&&h.parse(H)||q(H);m.add(C,G);E(C,G);b.trigger("afterSearch");x.css("display","none")}})}else{t.emptyList();B(C)}}}function q(E){var B=[];var D=E.split("\n");for(var C=0;C<D.length;C++){var F=a.trim(D[C]);if(F){F=F.split("|");B[B.length]={data:F,value:F[0],result:h.formatResult&&h.formatResult(F,F[0])||F[0]}}}return B}function o(){b.removeClass(h.loadingClass)}};a.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",loadingClass:"ac_loading",minChars:1,delay:400,matchCase:false,matchSubset:true,matchContains:false,cacheLength:10,max:100,mustMatch:false,extraParams:{},selectFirst:true,formatItem:function(b){return b[0]},formatMatch:null,autoFill:false,width:0,multiple:false,multipleSeparator:", ",highlight:function(c,b){return c.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:200};a.Autocompleter.Cache=function(c){var f={};var d=0;function h(l,k){if(!c.matchCase){l=l.toLowerCase()}var j=l.indexOf(k);if(c.matchContains=="word"){j=l.toLowerCase().search("\\b"+k.toLowerCase())}if(j==-1){return false}return j==0||c.matchContains}function g(j,i){if(d>c.cacheLength){b()}if(!f[j]){d++}f[j]=i}function e(){if(!c.data){return false}var k={},j=0;if(!c.url){c.cacheLength=1}k[""]=[];for(var m=0,l=c.data.length;m<l;m++){var p=c.data[m];p=(typeof p=="string")?[p]:p;var o=c.formatMatch(p,m+1,c.data.length);if(o===false){continue}var n=o.charAt(0).toLowerCase();if(!k[n]){k[n]=[]}var q={value:o,data:p,result:c.formatResult&&c.formatResult(p)||o};k[n].push(q);if(j++<c.max){k[""].push(q)}}a.each(k,function(r,s){c.cacheLength++;g(r,s)})}setTimeout(e,25);function b(){f={};d=0}return{flush:b,add:g,populate:e,load:function(n){if(!c.cacheLength||!d){return null}if(!c.url&&c.matchContains){var m=[];for(var j in f){if(j.length>0){var o=f[j];a.each(o,function(p,k){if(h(k.value,n)){m.push(k)}})}}return m}else{if(f[n]){return f[n]}else{if(c.matchSubset){for(var l=n.length-1;l>=c.minChars;l--){var o=f[n.substr(0,l)];if(o){var m=[];a.each(o,function(p,k){if(h(k.value,n)){m[m.length]=k}});return m}}}}}return null}}};a.Autocompleter.Select=function(e,j,l,p){var i={ACTIVE:"ac_over"};var k,f=-1,r,m="",s=true,c,o;function n(){if(!s){return}c=a("<div/>").hide().addClass(e.resultsClass).css("position","absolute").appendTo(document.body);o=a("<ul/>").appendTo(c).mouseover(function(t){if(q(t).nodeName&&q(t).nodeName.toUpperCase()=="LI"){f=a("li",o).removeClass(i.ACTIVE).index(q(t));a(q(t)).addClass(i.ACTIVE)}}).click(function(t){a(q(t)).addClass(i.ACTIVE);l();j.focus();return false}).mousedown(function(){p.mouseDownOnSelect=true}).mouseup(function(){p.mouseDownOnSelect=false});if(e.width>0){c.css("width",e.width)}s=false}function q(u){var t=u.target;while(t&&t.tagName!="LI"){t=t.parentNode}if(!t){return[]}return t}function h(t){k.slice(f,f+1).removeClass(i.ACTIVE);g(t);var v=k.slice(f,f+1).addClass(i.ACTIVE);if(e.scroll){var u=0;k.slice(0,f).each(function(){u+=this.offsetHeight});if((u+v[0].offsetHeight-o.scrollTop())>o[0].clientHeight){o.scrollTop(u+v[0].offsetHeight-o.innerHeight())}else{if(u<o.scrollTop()){o.scrollTop(u)}}}}function g(t){f+=t;if(f<0){f=k.size()-1}else{if(f>=k.size()){f=0}}}function b(t){return e.max&&e.max<t?e.max:t}function d(){o.empty();var u=b(r.length);for(var v=0;v<u;v++){if(!r[v]){continue}var w=e.formatItem(r[v].data,v+1,u,r[v].value,m);if(w===false){continue}var t=a("<li/>").html(e.highlight(w,m)).addClass(v%2==0?"ac_even":"ac_odd").appendTo(o)[0];a.data(t,"ac_data",r[v])}k=o.find("li");if(e.selectFirst){k.slice(0,1).addClass(i.ACTIVE);f=0}if(a.fn.bgiframe){o.bgiframe()}}return{display:function(u,t){n();r=u;m=t;d()},next:function(){h(1)},prev:function(){h(-1)},pageUp:function(){if(f!=0&&f-8<0){h(-f)}else{h(-8)}},pageDown:function(){if(f!=k.size()-1&&f+8>k.size()){h(k.size()-1-f)}else{h(8)}},hide:function(){c&&c.hide();k&&k.removeClass(i.ACTIVE);f=-1},visible:function(){return c&&c.is(":visible")},current:function(){return this.visible()&&(k.filter("."+i.ACTIVE)[0]||e.selectFirst&&k[0])},show:function(){var v=a(j).offset();c.css({width:typeof e.width=="string"||e.width>0?e.width:a(j).width(),top:v.top+j.offsetHeight,left:v.left}).show();if(e.scroll){o.scrollTop(0);o.css({maxHeight:e.scrollHeight,overflow:"auto"});if(a.browser.msie&&typeof document.body.style.maxHeight==="undefined"){var t=0;k.each(function(){t+=this.offsetHeight});var u=t>e.scrollHeight;o.css("height",u?e.scrollHeight:t);if(!u){k.width(o.width()-parseInt(k.css("padding-left"))-parseInt(k.css("padding-right")))}}}},selected:function(){var t=k&&k.filter("."+i.ACTIVE).removeClass(i.ACTIVE);return t&&t.length&&a.data(t[0],"ac_data")},emptyList:function(){o&&o.empty()},unbind:function(){c&&c.remove()}}};a.Autocompleter.Selection=function(d,e,c){if(d.createTextRange){var b=d.createTextRange();b.collapse(true);b.moveStart("character",e);b.moveEnd("character",c);b.select()}else{if(d.setSelectionRange){d.setSelectionRange(e,c)}else{if(d.selectionStart){d.selectionStart=e;d.selectionEnd=c}}}d.focus()}})(jQuery);